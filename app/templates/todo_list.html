{% extends "index.html" %}

{% block titulo %} Minha Lista de Tarefas {% endblock %}

{% block conteudo %}

<div class="max-w-xl mx-auto mt-8 p-4 bg-white rounded-full shadow-lg flex items-center justify-between">
    <form id='task_form' class="flex w-full mb-0"> {% csrf_token %}

        <input type="text" id="task-input" name='titulo' placeholder="O que você precisa fazer?" class="flex-1 text-lg px-5 border-none focus:outline-none focus:ring-0 text-gray-800 font-semibold rounded-full" required>

        <button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-full hover:bg-indigo-700 transition duration-150 font-semibold shadow-md">Adicionar</button>
    </form>
</div>

<div class="max-w-xl mx-auto">
    <div id='task-list' class='mt-8'>
        </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('task_form'); 
        const input = document.getElementById('task-input');
        const taskListContainer = document.getElementById('task-list');

        // Pega o token CSRF do Django para o POST
        const csrf_token = document.querySelector('[name=csrfmiddlewaretoken]').value; // Corrigido para pegar o .value

        // Cria HTML da Tarefa
        function createTask(tarefa){ 
            const taskDiv = document.createElement('div');

            // Add ID da tarefa ao div pai
            taskDiv.dataset.id = tarefa.id;
            
            const isConcluida = tarefa.status == 'concluída';

            taskDiv.className = 'bg-white bg-opacity-90 text-gray-900 p-4 rounded-lg mb-3 flex justify-between items-center shadow';

            // Também corrigi o bug visual do 'text-gray-500' duplicado
            taskDiv.innerHTML = `
                <span class="text-lg ${isConcluida ? 'line-through text-gray-500' : ''}">
                    ${tarefa.id} - ${tarefa.titulo}
                    <span class="text-sm font-medium text-gray-600">(${tarefa.status})</span>
                </span>

                <div class='flex space-x-2'>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" 
                         class="size-6 btn-concluir ${isConcluida ? 'text-green-500' : 'text-gray-500'} hover:text-green-500 cursor-pointer">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                    
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" 
                         class="size-6 btn-excluir text-gray-500 hover:text-red-500 cursor-pointer">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                    </svg>
                </div>
                `;
            return taskDiv;
        }

        // Busca tarefa
        async function fetchTasks(){
            try {
                const response = await fetch('/api/tarefas/'); // Chama API GET
                if (!response.ok) throw new Error('Erro ao buscar tarefas');
                
                const tarefas = await response.json(); // Converte a resposta em JSON
                
                // Limpa a lista antes de adicionar
                taskListContainer.innerHTML = '';
                
                // Adiciona cada tarefa no HTML
                tarefas.forEach(tarefa => {
                    const taskElement = createTask(tarefa); // Usando sua função 'createTask'
                    taskListContainer.appendChild(taskElement);
                });

            } catch (error) {
                console.error('Erro:', error);
                taskListContainer.innerHTML = '<p class="text-white text-center">Não foi possível carregar as tarefas.</p>';
            }
        }

        // Lidar com envio do formulário
        form.addEventListener('submit', async (event) => {
            event.preventDefault(); // Impede o recarregamento da página

            const titulo = input.value.trim(); 
            if (!titulo) return; 

            try {
                const response = await fetch('/api/tarefas/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrf_token
                    },
                    body: JSON.stringify({
                        titulo: titulo 
                    })
                });

                if (response.status === 201) { // 201 = Created (Sucesso!)
                    const novaTarefa = await response.json();
                    
                    const taskElement = createTask(novaTarefa); // Usando sua função 'createTask'
                    taskListContainer.prepend(taskElement);
                    
                    input.value = ''; // Limpa o campo do formulário
                } else {
                    const erroData = await response.json();
                    alert('Erro ao criar tarefa: ' + (erroData.erro || 'Erro desconhecido'));
                }

            } catch (error) {
                console.error('Erro:', error);
                alert('Uma falha de conexão ocorreu.');
            }
        });

        // Chama a função para buscar as tarefas assim que a página carrega
        fetchTasks();

        // Adiciona um event listener ao container PAI
        taskListContainer.addEventListener('click', async(event) =>{
            
            // Captura o ícone clicado
            const clickElement = event.target.closest('svg');
            if(!clickElement) return; // Não ocorre nada se não for svg
            
            // Div da tarefa
            const taskDiv = clickElement.closest('[data-id]');
            if(!taskDiv) return;

            const id = taskDiv.dataset.id; // ID da tarefa

            if(clickElement.classList.contains('btn-concluir')){
                try{
                    const response = await fetch(`/api/tarefas/${id}/`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrf_token
                        },
                        body: JSON.stringify({
                            status:'concluída' // Envia o novo status
                        })
                    });
                    if(!response.ok) throw new Error('Falha ao atualizar tarefa');

                    taskDiv.querySelector('span.text-lg').classList.add('line-through', 'text-gray-500');
                    taskDiv.querySelector('span.text-sm').innerText = '(concluída)';
                    clickElement.classList.add('text-green-500');
                    clickElement.classList.remove('text-gray-500');
                } catch (error){
                    console.error('Erro ao concluir:', error)
                    alert('Não foi possível marcar a tarefa como concluída.');
                }
            }

            if(clickElement.classList.contains('btn-excluir')){
                if(!confirm('Tem certeza que deseja excluir esta tarefa?')){
                    return
                }
                try{
                    const response = await fetch(`/api/tarefas/${id}/`,{
                        method:'DELETE',
                        headers: {
                            'X-CSRFToken':csrf_token
                        }
                    });
                    if(response.status === 204){
                        taskDiv.remove();
                    } else {
                        throw new Error('Falhas ao excluir a tarefa.');
                    }
                } catch(error){
                    console.error('Erro ao excluir: ', error);
                    alert('Não foi possível excluir a tarefa.');
                }
            }
        });
    });
</script>
{% endblock %}